# Prometheus-manager

> prometheus ç»Ÿä¸€ç›‘æ§å‘Šè­¦å¹³å°

<h1 style="display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; text-align: center;">
    <img alt="Prometheus" src="img/logo.svg">
    <img alt="Prometheus" src="img/prometheus-logo.svg">
</h1>

## ç³»ç»Ÿä»‹ç»

1. ä¸€æ¬¾åŸºäºPrometheusçš„ç›‘æ§å¹³å°ï¼Œæ”¯æŒå¤šç§å‘Šè­¦ç­–ç•¥ï¼Œé›†æˆå‘Šè­¦é€šçŸ¥ã€å‘Šè­¦å†å²ã€å‘Šè­¦å›¾è¡¨

* ä½“éªŒdemo
  > https://prometheus.aide-cloud.cn/
  > 
  > è´¦å·ï¼šprometheus
  > 
  > å¯†ç ï¼š123456

* [ç›¸å…³åšæ–‡](https://juejin.cn/post/7329734768258760719) 

*  ğŸ‘‰ [å¿«é€Ÿå¼€å§‹](../README.md)

## é¡¹ç›®ç®€ä»‹

### PromServer æœåŠ¡ç«¯

> æ“ä½œå¹³å°ï¼Œ æä¾›æœåŠ¡ç«¯æ¥å£ï¼Œæä¾›å‘Šè­¦ç­–ç•¥ç®¡ç†ï¼Œ å‘Šè­¦é€šçŸ¥ï¼Œå‘Šè­¦å†å²ï¼Œå‘Šè­¦å›¾è¡¨ç­‰æœåŠ¡

* ç™»å½•æ¨¡å—
* ç³»ç»Ÿæ¨¡å—
  * ç”¨æˆ·ç®¡ç†
  * è§’è‰²ç®¡ç†
  * æƒé™ç®¡ç†
* å‘Šè­¦æ¨¡å—
  * å®æ—¶å‘Šè­¦
    * ç¼–è¾‘è§„åˆ™æ—¶å€™å¯ä»¥å…³è”æŠ¥è­¦é¡µé¢ï¼Œ å½“å‘Šè­¦äº‹ä»¶å‘ç”Ÿæ—¶å€™ï¼Œä¼šæŠŠæ­¤ç±»å‘Šè­¦å±•ç¤ºåˆ°å¹³å°çš„åˆ¶å®šé¡µé¢ï¼Œæ”¯æŒåŒä¸€ä¸ªå‘Šè­¦å±•ç¤ºåˆ°å¤šä¸ªé¡µé¢
  * å†å²å‘Šè­¦
    * ç”¨äºæŸ¥çœ‹å‘Šè­¦å†å²ï¼Œä½œä¸ºå¤ç›˜çš„æ•°æ®æ”¯æ’‘
  * å‘Šè­¦ç­–ç•¥ç»„
    * å¯¹åº”prometheuså‘Šè­¦çš„è§„åˆ™ç»„ï¼Œè§„åˆ™ç»„ä¸‹å¯ä»¥é…ç½®å¤šä¸ªå‘Šè­¦ç­–ç•¥ï¼ˆè§„åˆ™ï¼‰
  * å‘Šè­¦ç­–ç•¥
    * å®é™…çš„æŠ¥è­¦è§„åˆ™ç®¡ç†åŠŸèƒ½ï¼Œ åœ¨è¿™é‡Œå¯ä»¥å¯è§†åŒ–ç¼–è¾‘å‘Šè­¦è§„åˆ™ï¼Œ ä¹Ÿèƒ½å®æ—¶æŸ¥çœ‹å‘Šè­¦è§„åˆ™å¯¹åº”çš„æ•°æ®å›¾è¡¨ï¼Œå‘Šè­¦è§„åˆ™ç¼–è¾‘è¿‡ç¨‹ä¸­æ”¯æŒè¯­æ³•æ ¡éªŒã€æ™ºèƒ½æç¤ºç­‰ï¼Œ å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¿«æ›´å‡†ç¡®çš„é…ç½®å‘Šè­¦
  * æ•°æ®æº
    * åœ¨å®é™…ç”Ÿæ´»ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½é¢ä¸´æœ‰å¤šä¸ªpromæ•°æ®æºçš„é—®é¢˜ï¼Œ è¿™é‡Œç›´æ¥æä¾›äº†æ•°æ®æºç®¡ç†åŠŸèƒ½ï¼Œ å¯ä»¥æ–¹ä¾¿çš„æ·»åŠ ã€åˆ é™¤ã€ä¿®æ”¹æ•°æ®æºï¼Œç„¶ååœ¨ç¼–è¾‘è§„åˆ™è¿‡ç¨‹ä¸­ï¼Œå¯¹è§„åˆ™ç›´æ¥ä½¿ç”¨å¯¹åº”çš„æ•°æ®æºå³å¯
  * hookç®¡ç†
    * hookæ˜¯å‘Šè­¦é€šçŸ¥çš„ä¸€ç§é‡è¦æ‰‹æ®µï¼Œ æ–¹ä¾¿æˆ‘ä»¬é›†æˆå‘Šè­¦åˆ°å…¶ä»–ç³»ç»Ÿï¼Œè¿™é‡Œæä¾›äº†å¸¸è§çš„hookç®¡ç†ï¼Œ ä¾‹å¦‚ï¼šé’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ã€é£ä¹¦ã€ç¬¬ä¸‰æ–¹è‡ªå®šä¹‰hookç­‰ï¼Œhookæœ¬èº«è¿˜æ”¯æŒå‘Šè­¦æ¨¡æ¿åŠŸèƒ½ï¼Œ ä¸ºæˆ‘ä»¬å®šåˆ¶å‘Šè­¦å†…å®¹æä¾›äº†æ›´åŠ æ–¹ä¾¿çš„å§¿åŠ¿
  * å‘Šè­¦ç»„ç®¡ç†
    * ç”¨äºæŠŠç›¸åŒå±æ€§çš„ä¸€ç±»é€šçŸ¥å¯¹è±¡è¿›è¡Œåˆ†ç»„ï¼Œ ç„¶ååœ¨é…ç½®å‘Šè­¦ç­–ç•¥æ—¶å€™ç›´æ¥ç»‘å®šå‘Šè­¦ç»„ï¼Œ è¿™æ ·å‘Šè­¦å‘ç”Ÿæ—¶å€™ï¼Œèƒ½ç›´æ¥æŠŠå‘Šè­¦ä¿¡æ¯å‘ç”Ÿç»™æŒ‡å®šçš„é€šçŸ¥å¯¹è±¡äº†

### PromAgent ä»£ç†ç«¯

> é€‚é…ä¸åŒæ•°æ®æºï¼Œå®Œæˆç­–ç•¥è¯†åˆ«ï¼Œç”Ÿæˆå‘Šè­¦/å‘Šè­¦æ¢å¤äº‹ä»¶

## ç³»ç»Ÿæ¶æ„

![æ¶æ„æ¦‚è§ˆ](img/Prometheus-manager.png)

## å¼€å‘

```bash
# å…‹éš†ä»£ç 
git clone https://github.com/aide-cloud/prometheus-manager.git

# è¿›å…¥é¡¹ç›®ç›®å½•
cd prometheus-manager

# å®‰è£…ä¾èµ–
make init

# å¯åŠ¨æœåŠ¡
# æœåŠ¡ç«¯
make local app=app/prom_server
# ä»£ç†ç«¯
make local app=app/prom_agent
```

## è¿è¡Œæ•ˆæœ

* ç­–ç•¥åˆ—è¡¨

![ç­–ç•¥åˆ—è¡¨](img/runtime/strategy-list.png)

* ç­–ç•¥ç¼–è¾‘

![ç­–ç•¥ç¼–è¾‘](img/runtime/update-strategy.png)

* æŒ‡æ ‡ç¼–è¾‘

![æŒ‡æ ‡ç¼–è¾‘](img/runtime/metric-update.png)

* æŒ‡æ ‡åˆ—è¡¨

![æŒ‡æ ‡åˆ—è¡¨](img/runtime/metric-list.png)

* æŒ‡æ ‡åˆ—è¡¨

![æŒ‡æ ‡å›¾è¡¨](img/runtime/metric-chart.png)

* å®æ—¶å‘Šè­¦é¡µé¢

![å®æ—¶å‘Šè­¦é¡µé¢](img/runtime/realtime-alarm.png)

* å®æ—¶å‘Šè­¦ç»Ÿè®¡

![å®æ—¶å‘Šè­¦ç»Ÿè®¡](img/runtime/realtime-alarm-count.png)

## å‘Šè­¦é€šçŸ¥

* é€šçŸ¥æ¨¡æ¿

```markdown
## prometheusç›‘æ§å‘Šè­¦ã€{{ $status }}ã€‘

* å‘Šè­¦æ—¶é—´: {{ $startsAt }}
* æ¢å¤æ—¶é—´: {{ $endsAt }}
* å‘Šè­¦æ ‡é¢˜: {{ $annotations.title }}
* å‘Šè­¦å†…å®¹: {{ $annotations.description }}
* å”¯ä¸€æŒ‡çº¹: {{ $fingerprint }}
* å‘Šè­¦æ ‡è¯†
    * è§„åˆ™åç§°: {{ $labels.alertname }}
    * æœºå™¨åç§°: {{ $labels.endpoint }}
    * å®ä¾‹åç§°: {{ $labels.instance }}
```

* é€šçŸ¥ç¤ºä¾‹
![ä¼å¾®å‘Šè­¦é€šçŸ¥](img/runtime/alarm-hook-info.png)

* é£ä¹¦é€šçŸ¥æ¨¡æ¿

```json
{
  "msg_type": "interactive",
  "card": {
    "elements": [
      {
        "tag": "div",
        "text": {
          "content": "* å‘Šè­¦æ—¶é—´: {{ $startsAt }}\n* æ¢å¤æ—¶é—´: {{ $endsAt }}\n* å‘Šè­¦æ ‡é¢˜: {{ $annotations.title }}\n* å‘Šè­¦å†…å®¹: {{ $annotations.description }}\n* å”¯ä¸€æŒ‡çº¹: {{ $fingerprint }}\n* å‘Šè­¦æ ‡è¯†\n    * è§„åˆ™åç§°: {{ $labels.alertname }}\n    * æœºå™¨åç§°: {{ $labels.endpoint }}\n    * å®ä¾‹åç§°: {{ $labels.instance }}",
          "tag": "lark_md"
        }
      }
    ],
    "header": {
      "title": {
        "content": "prometheusç›‘æ§å‘Šè­¦ã€{{ $status }}ã€‘",
        "tag": "plain_text"
      }
    }
  }
}
```

* é£ä¹¦é€šçŸ¥ç¤ºä¾‹

![é£ä¹¦é€šçŸ¥ç¤ºä¾‹](img/runtime/feishu-alert-hook.png)

* ç­–ç•¥ç»‘å®šå‘Šè­¦é€šçŸ¥ç»„

![ç­–ç•¥ç»‘å®šå‘Šè­¦é€šçŸ¥ç»„](img/runtime/strategy-bind-notify.png)

* å‘Šè­¦ç»„ç®¡ç†

![å‘Šè­¦ç»„ç®¡ç†](img/runtime/notify-group-manage.png)

* hookæœºå™¨äººç®¡ç†

![hookæœºå™¨äººç®¡ç†](img/runtime/hook-manage.png)

* æ•°æ®æºç®¡ç†

![æ•°æ®æºç®¡ç†](img/runtime/datasource-manage.png)

