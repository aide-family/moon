apiVersion: v1
kind: ConfigMap
metadata:
  name: rabbit-config
  namespace: application
data:
  config.yaml: |-
    env: dev
    
    dependPalace: true
    server:
      name: moon_rabbit
      httpEndpoint: "rabbit.application.svc.cluster.local:8002"
      grpcEndpoint: "rabbit.application.svc.cluster.local:9002"
      network: "rpc"
      secret: ""
      metadata:
        description: æ˜¯moonç›‘æ§ç³»åˆ—çš„æ¶ˆæ¯ç»„ä»¶ï¼Œå¯ä»¥ç‹¬ç«‹éƒ¨ç½²ï¼Œæ¥å—ä»»æ„çš„hookæ¶ˆæ¯ï¼Œå¹¶æ”¯æŒé‚®ä»¶ã€é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ã€é£ä¹¦ç­‰å‘Šè­¦
        background: å¯“æ„ä¸ºæœˆå®«ä¸­çš„ç‰å…”ï¼Œä¸“é—¨ç”¨äºæ¶ˆæ¯é€šçŸ¥
    
    http:
      addr: 0.0.0.0:8002
      timeout: 2s
    grpc:
      addr: 0.0.0.0:9002
      timeout: 2s

    log:
      type: "slog"
      level: "debug"
      slog:
        json: true    

    cache:
      driver: "redis"
      redis:
        network: "tcp"
        addr: redis.middleware.svc.cluster.local:6379
        db: 0
        password: "lQz8OMgje7UyoD"
        read_timeout: 0.2s
        write_timeout: 0.2s
        dial_timeout: 0.2s

    global_email_config:
      host: smtp.163.com
      port: 25
      user: 
      pass: 

    palace_server:
      network: "rpc"
      nodeVersion: ""
      endpoint: "palace.application.svc.cluster.local:9000"
      timeout: 50s
      secret: ""
    
    # TODO è°ƒæ•´æ¨¡æ¿ç»“æ„ï¼Œ æ”¯æŒå¤šç§Ÿæˆ·
    templates:
      email: |
        <h1>ç›‘æ§å‘Šè­¦</h1>
        <p>{{ .annotations.summary }}</p>
        <p>{{ .annotations.description }}</p>
        <p>æ—¶é—´: {{ .startsAt }} è‡³ {{ .endsAt }}</p>
      dingtalk: |
        {{- $status := .status -}}
        {{- $labels := .labels -}}
        {{- $annotations := .annotations -}}
        
        {
            "msgtype": "markdown",
            "markdown": {
              "title": "å¹³å°çŠ¶æ€é€šçŸ¥",
              "text": "### {{if eq $status `resolved`}}âœ… å‘Šè­¦å·²æ¢å¤{{else}}ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ç´§æ€¥å‘Šè­¦é€šçŸ¥{{end}}\n\n  \n**æ—¶é—´**: `{{ .startsAt }}` è‡³ `{{ .endsAt }}`  \n\n<hr/>\n\n**æ‘˜è¦**:  \n`{{ $annotations.summary }}`  \n\n**æè¿°**:  \n`{{ $annotations.description }}`  \n\n<hr/>\n\n**æ ‡ç­¾**:  \n- **æ•°æ®æº ID**: {{ index $labels "__moon__datasource_id__" }}  \n- **æ•°æ®æº URL**: [é“¾æ¥]({{ index $labels "__moon__datasource_url__" }})  \n- **çº§åˆ« ID**: {{ index $labels "__moon__level_id__" }}  \n- **ç­–ç•¥ ID**: {{ index $labels "__moon__strategy_id__" }}  \n- **å›¢é˜Ÿ ID**: {{ index $labels "__moon__team_id__" }}  \n- **å®ä¾‹**: `{{ index $labels "instance" }}`  \n- **IP**: `{{ index $labels "ip" }}`  \n- **ä½œä¸š**: `{{ index $labels "job" }}`  \n\n<hr/>\n\nè¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯è¿›è¡Œåç»­å¤„ç†ï¼"
            }
        }
    
      feishu: |
        {
            "msg_type": "interactive",
            "card": {
                "config": {
                    "wide_screen_mode": true
                },
                "header": {
                    "title": {
                        "tag": "plain_text",
                        "content": "{{if eq .status `resolved`}}âœ… å‘Šè­¦å·²æ¢å¤{{else}}ğŸš¨ ç´§æ€¥å‘Šè­¦é€šçŸ¥{{end}}"
                    },
                    "template": "{{if eq .status `resolved`}}green{{else}}red{{end}}"
                },
                "elements": [
                    {
                        "tag": "div",
                        "fields": [
                            {
                                "is_short": false,
                                "text": {
                                    "tag": "lark_md",
                                    "content": "**ğŸ” å‘Šè­¦æ‘˜è¦**\n{{.annotations.summary}}"
                                }
                            },
                            {
                                "is_short": false,
                                "text": {
                                    "tag": "lark_md",
                                    "content": "**ğŸ” å‘Šè­¦æè¿°**\n{{.annotations.description}}"
                                }
                            },
                            {
                                "is_short": false,
                                "text": {
                                    "tag": "lark_md",
                                    "content": "**ğŸ” å¼€å§‹æ—¶é—´**\n{{.startsAt}}"
                                }
                            },
                            {
                                "is_short": false,
                                "text": {
                                    "tag": "lark_md",
                                    "content": "{{if eq .status `resolved`}}**ğŸ” æ¢å¤æ—¶é—´**\n{{.endsAt}}{{end}}"
                                }
                            }
                        ]
                    },
                    {
                        "tag": "hr"
                    },
                    {
                      "tag": "div",
                      "fields": [
                        {
                          "is_short": true,
                          "text": {
                            "tag": "lark_md",
                            "content": "**â— çŠ¶æ€**\n<font color=\"warning\">{{.status}}</font>"
                          }
                        },
                        {
                          "is_short": true,
                          "text": {
                            "tag": "lark_md",
                            "content": "**ğŸŒ æ•°æ®æº**\n[ç‚¹å‡»æŸ¥çœ‹]({{.labels.__moon__datasource_url__}})"
                          }
                        },
                        {
                          "is_short": true,
                          "text": {
                            "tag": "lark_md",
                            "content": "**ğŸ“› å‘Šè­¦åç§°**\n<font color=\"info\">{{.labels.__name__}}</font>"
                          }
                        },
                        {
                          "is_short": true,
                          "text": {
                            "tag": "lark_md",
                            "content": "**ğŸ”— ç­–ç•¥ ID**\n{{.labels.__moon__strategy_id__}}"
                          }
                        },
                        {
                          "is_short": true,
                          "text": {
                            "tag": "lark_md",
                            "content": "**ğŸ†” å›¢é˜Ÿ ID**\n{{.labels.__moon__team_id__}}"
                          }
                        },
                        {
                          "is_short": true,
                          "text": {
                            "tag": "lark_md",
                            "content": "**ğŸ’» IP åœ°å€**\n{{.labels.ip}}"
                          }
                        }
                      ]
                    },
                    {
                        "tag": "hr"
                    },
                    {
                        "tag": "action",
                        "actions": [
                            {
                                "tag": "button",
                                "text": {
                                    "tag": "lark_md",
                                    "content": "ğŸ“„ æŸ¥çœ‹è¯¦æƒ…"
                                },
                                "url": "{{.labels.__moon__datasource_url__}}",
                                "type": "primary"
                            }
                        ]
                    }
                ]
            }
        }
    
      wechat: |
        {
            "msgtype": "markdown",
            "markdown": {
              "content": "### {{if eq .status `resolved`}}âœ… å‘Šè­¦å·²æ¢å¤{{else}}ğŸš¨ ç´§æ€¥å‘Šè­¦é€šçŸ¥{{end}}\n\n {{ .annotations }}"
            }
        }
